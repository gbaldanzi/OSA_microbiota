---
title: "Sleep apnea and gut microbiota"
author: "Gabriel Baldanzi"
date: " `r Sys.time()` "
output: 
  html_document:
    fig_width: 6
    fig_height: 4
    number_sections: TRUE
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
    css: style.css
---
```{css, echo=FALSE}
    body .main-container {
      max-width: 1500px !important;
      width: 1500px !important;
    }
    body {
      max-width: 1500px !important;
    }
    code.r { /* Code block */
    font-size: 12pt;
    }
    ```


# Sleep apnea variables
<br>    

```{r apnealinkpicture, echo=FALSE, fig.align='left', out.width="30%", out.height="30%"}
knitr::include_graphics("apnealink.jpeg")
```

<br>
<br>
Variables:   
    
1. **AHI** (Apnea-hypopnea index)   
- Main parameter for OSA diagnosis and severity stratification   

* AHI 5-15 = Mild   
* AHI 15-30 = Moderate   
* AHI â‰¥30 = Severe   

<br>
2. **ODI** (Oxygen desaturation index)  
- Alternative variable for OSA diagnosis  

<br>
3. **Percentage of time with saturation below 90%**  
- Used for phenotypic characterization of OSA  

<br>   

***

# Sleep recording data

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
options(width = 20)
library(grid)
library(chron)
library(rio)
library(Hmisc)
library(tidyverse)
library(sjmisc)
library(summarytools)
library(janitor)
library(data.table)
library(flextable)
library(kableExtra)
library(compareGroups)
library(RColorBrewer)
library(pROC)
```

```{r chunk1, message=FALSE, warning=FALSE, include=FALSE}
rm(list=ls())
setwd("/home/baldanzi/Datasets/sleep_SCAPIS/sleep_recording")
sleep = fread("Data_Sleep_SCAPIS_Uppsala.csv", header=T, na.strings=c("", "NA"))

# Data summary 
attach(sleep)
nr.idnr = length(idnr) # total number individuals 
nr.idnr.valid = length(idnr[flutv4h==1 & o2utv4h==1]) # number of ind with at least 4h of flow and sat monitoring 
fl = summary(fldeutv_min) 
fl = substr(times((fl%/%60 +  fl%%60 /60)/24), 1, 5) # Mean and median duration of flow monitoring 

sat = summary(spo2utv_min)
sat = substr(times((sat%/%60 +  sat%%60 /60)/24), 1, 5) # Mean and median duration of flow monitoring
detach(sleep)
#subsetting the dataset to only those with valid flow and sat monitoring 
valid.ahi = sleep[flutv4h==1 & o2utv4h==1,]
#subsetting the dataset to only those with valid sat monitoring (enough for analysis with ODI or Sat90%)
valid.odi = sleep[o2utv4h==1,]

correlation = round(with(valid.ahi[!is.na(odi),], cor(ahi,odi)),3)
```
    
Total number of individuals    
N =  **`r nr.idnr`**   
   
Individuals with valid ODI measurements (at least 4hrs of saturation monitoring)        
N = **`r sum(sleep$o2utv4h==1)`**   
   
Individuals with valid AHI measurements (at least 4hrs of saturation and flow monitoring)      
N  = **`r nr.idnr.valid`**    

<br>

Correlation between AHI and ODI in the study pop. = **`r correlation`**   
<br>

## {.tabset}

### Oximetry monitoring 

   
```{r summaryoximetry, echo =FALSE, message=FALSE, warning=FALSE}
a = data.frame(Estimates=names(sat), "HH:MM"=sat)
rownames(a) =NULL
knitr::kable(a, caption = "Duration of oximetry monitoring", table.attr = "style='width:40%;'") %>% 
  kable_styling()
```    

### Flow monitoring

```{r summaryflow, echo =FALSE, message=FALSE, warning=FALSE}   
a = data.frame(Estimates=names(fl), "HH:MM"=fl)
rownames(a) =NULL
knitr::kable(a, caption = "Duration of flow monitoring", table.attr = "style='width:40%;'") %>% 
  kable_styling()
```


&nbsp;


***   
   
<br>  
   
   
# Gut microbiome data 

Uppsala participants with gut microbiome data = **4839**   
   
```{r chunk2, message=FALSE, warning=FALSE, include=FALSE}
# Importing data on valid.ahi
setwd("/home/baldanzi/Datasets/sleep_SCAPIS")
# Uploading dataset with variables in factor format
load("data_table1")
# Importing data on individuals with valid.ahi measurement 
valid.ahi = fread("validsleep.MGS.Upp.tsv", header=T, na.strings=c("", "NA"))
#merging with the data set that has variables as factor 
a = names(dat1[,-"SCAPISid"])
valid.ahi[,(a):=NULL]
valid.ahi = merge(dat1,valid.ahi, by = "SCAPISid", all=T, all.x=F, all.y=F)
```
<br>   
  
***   
   
<br>   

# Study population for main analyses: valid AHI + gut microbiota data 

Uppsala participants with both valid AHI and gut microbiota data = **`r nrow(valid.ahi)`**   
   
<br>  

## AHI 
 
```{r sleeprecordsplots, echo = FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Histogram AHI
p3 = ggplot(data = valid.ahi, aes(x=ahi)) + geom_histogram()  +
  ggtitle("Hist Apnea-hypopnea index (AHI)") +  xlab("") + 
  geom_vline(xintercept = 5, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 15, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 30, color = "red", linetype = "twodash") +
  annotation_custom(textGrob("5", gp = gpar(col = "red")), 
                    xmin=6, xmax=6,ymin=1000, ymax=1000) + 
   annotation_custom(textGrob("15", gp = gpar(col = "red")), 
                    xmin=16.5, xmax=16.5,ymin=1000, ymax=1000) +
     annotation_custom(textGrob("30", gp = gpar(col = "red")), 
                    xmin=31.6, xmax=31.6,ymin=1000, ymax=1000) +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5))
g = ggplotGrob(p3)
  g$layout$clip[g$layout$name=="panel"] <- "off"
  grid.draw(g)
```
<br>
<br> 

## Sleep apnea severity categories

```{r OSAfreqtable, echo = FALSE, warning = FALSE, message=FALSE}
#Frequency table by OSA cat 
a = round(as.data.frame(freq(valid.ahi$OSAcat)),1)
a = a[,c(1,4,3)]
knitr::kable(a, caption = "OSA severity categories", table.attr = "style='width:60%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

<br>
<br>

***

# Population characteristics  
   
 <br>  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#setwd("/home/baldanzi/Datasets/sleep_SCAPIS")
#table1csv = fread("table1.csv", header=T)
#setnames(table1csv, "p.overall", "p.value")
#knitr::kable(table1csv, caption = "Variables by groups of OSA severity") %>% 
#  kable_styling(fixed_thead = T) %>% 
#  scroll_box(height = "800px")
```

```{r table1but2,echo=FALSE, message=FALSE, warning=FALSE}
datatable1 = as.data.frame(dat1[,-1])  # Passing data to a new object with the SCAPIS ID

# For the purpose of this table, individuals with missing values for the following variables
# were included in the "no" category. (only category "yes" is displayed in the table)
for(i in which(names(datatable1) %in% c('hypertension', 'dyslipidemia', 'diabmed',
                                'hypermed','dyslipmed', 'cpap', 'splint'))){
 datatable1[is.na(datatable1[i]),i] = "no"
}

#Creating labels for the variables 
mylabel <- c("OSA severity", "Age (yrs)", "Sex", "Smoking status", "Alcohol intake (g)", 
             "BMI (kg/m2)", "WHR","Highest education achieved", "Self-reported leisure physical activity", 
             "Place of birth", "Type 2 diabetes", "Hypertension", "Dyslipidemia",
             "Diabetes medication",
             "Hypertension medication", "Dyslipidemia medication", "PPI", "Fiber", "AHI (events/h)", "ODI (events/h)", 
             "%time Sat=<90%", "ESS",  "CPAP", "Oral appliance")

j=1
for(i in names(datatable1)){
  label(datatable1[[i]]) <- mylabel[j]
  j=j+1
}

# Create table 1 
t = compareGroups(OSAcat ~ age + Sex + smokestatus + Alkohol + BMI + WaistHip + educat +
                  leisurePA + pob + diabd + hypertension + dyslipidemia + diabmed + 
                  hypermed + dyslipmed + Fibrer + ahi + odi+ sat90+ ESS+ cpap+ splint + ppi, data= datatable1, 
                  include.miss = TRUE, chisq.test.perm = TRUE)
t1 = createTable(t, hide.no = "no")
export2md(t1, which.table = "descr", header.labels = c(p.overall = "p-value"), 
          format = "html", strip = TRUE) %>% 
  kable_styling(fixed_thead = T) %>% 
scroll_box( height = "850px")
```
<br>
<br>
<br>

***

## BMI and AHI  

### {.tabset}

#### Table

```{r bmi, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
valid.ahi$BMIcat = 0
valid.ahi[BMI<25, BMIcat:=1]
valid.ahi[BMI>=25, BMIcat:=2]
valid.ahi[BMI>=30, BMIcat:=3]
valid.ahi$BMIcat = factor(valid.ahi$BMIcat, levels = c(1,2,3), labels = c("BMI<25", "BMI.25-30","BMI>=30"))
t = valid.ahi %>% group_by(BMIcat) %>% summarise(N=length(BMIcat), mean_ahi = round(mean(ahi),1), median_ahi = median(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI and BMI category",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```
<br>   

***

#### Box plot

```{r bmiahiboxplot, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

ggplot(valid.ahi, aes(x=BMIcat, y = ahi, fill=BMIcat)) + geom_boxplot() + ggtitle("AHI by BMI categories") +
  ylab("AHI") + xlab("BMI categories") +
   theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=13),
        legend.position = "none")
```
<br>   

***

#### Scatter plot

```{r plotsahiandbmi, echo =FALSE, message=FALSE, warning=FALSE,fig.align='center'}
# AHI by BMI
a = cor(valid.ahi$BMI, valid.ahi$ahi, method = "spearman")
pbmi = ggplot(data = valid.ahi, aes(y=ahi, x=BMI)) + geom_point()  +
  ggtitle(paste0("AHI and BMI \n Spear. cor = ",round(a,2))) +  
  xlab("BMI (kg/m2)") + ylab("AHI")+
    geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash", alpha=.3) +
  geom_smooth(method = 'lm') +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))
print(pbmi)

```

<br>   

***

## BMI and OSA severity categories  
```{r bmicat, echo=FALSE, message=FALSE, warning=FALSE}
t = compareGroups(BMIcat ~ OSAcat , data = valid.ahi)
t1 = createTable(t, show.p.overall=F)
export2md(t1, which.table = "descr",  
          format = "html", strip = TRUE, caption = "BMI vs OSA severity")  %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

<br>

***

## Other covariates 

```{r plotsahi, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI by sex 
means = round(with(valid.ahi, tapply(ahi, Sex, mean)),1)
psex = ggplot(data = valid.ahi, aes(y=ahi)) + geom_boxplot(aes(x=Sex, fill=Sex))  +
  ggtitle("AHI and sex ") +  xlab("sex") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=13),
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(means),"\n(mean AHI=",means,")"))
                          
print(psex)
```
<br>

***

<br>

```{r plotsahiandage, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI by age 
page = ggplot(data = valid.ahi, aes(x=age,y=ahi)) + geom_point()  +
  ggtitle("AHI and age ") +  xlab("Age (yrs)") + ylab("AHI")+
    geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash",alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash",alpha=.3) +
  geom_smooth(method='lm', alpha=.8) +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))  
  
print(page)
```
<br>
   
```{r crosstabahiandage, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
# Create variable of age categories
valid.ahi[age<55, agegroup:=1]
valid.ahi[age>=55 & age <60, agegroup:=2]
valid.ahi[age>=60, agegroup:=3]
valid.ahi[,agegroup:=factor(agegroup, levels=c(1,2,3), labels = c("Age<55", "Age 55-60", "Age>=60"))]

# Create box plot of ahi by age group
means = round(with(valid.ahi, tapply(ahi, agegroup, mean)),1)

ggplot(valid.ahi, aes(x=agegroup, y=ahi, fill = agegroup)) +
  geom_boxplot() +
  ggtitle("AHI by age group") +  xlab("Age groups") + ylab("AHI")+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=12),
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(means),"\n(mean AHI=",means,")"))

# Create table of ahi by age group
t = valid.ahi %>% group_by(agegroup) %>% summarise(N=length(ahi), median_ahi = round(median(ahi),1), mean_ahi = mean(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI by age group",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
``` 

***    

<br>

### Smoking    
         
**Smokestatus**:   
*Derived variable based on answers to cqto001 (lifestyle questionnaire
item) and SmokerLab (oral question on smoking status asked prior to
lab sampling). Cqto001 is the main source variable. Regular and
occasional smokers according to cqto001 are both classified as current
smokers. If answer to cqto001 is missing or "Not willing/able to
reply", and SmokerLab is yes, this information is used instead.*   
   
<br>    


**Smoking status based on SCAPIS derived variable**

```{r plotsahiandsmoking, echo =FALSE, message=FALSE, warning=FALSE}

# AHI and smoking 
a=table(valid.ahi$smokestatus, useNA = "ifany")
psmoke = ggplot(data = valid.ahi, aes(y=ahi)) + 
  geom_boxplot(aes(x=smokestatus, fill=smokestatus))  +
  ggtitle("AHI and smoking") +  xlab("Smoking status") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"),
        axis.text.x = element_text(size=13),
        legend.position = "none")+
  scale_x_discrete(labels=paste0(names(a),"\n(n=",a,")"))
print(psmoke)

# Create table of ahi by age group
t = valid.ahi %>% group_by(smokestatus) %>% summarise(N=length(ahi), median_ahi = round(median(ahi),1), mean_ahi = mean(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI by smoking status",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
``` 

<br>

***

**Smoking status based on metabolomics data**


163 individuals are missing information on smoking status.    
One suggested alternative is to use a nicotine metabolite as a proxy. 
   

Smoking-related metabolites:   
   
1. Cotinine - most used and studied
2. Hydroxycotinine
3. Cotinine N-oxide
    
 <br>      

```{r nicotine_metabolites1, echo=FALSE, message=FALSE, warning=FALSE}
nicmet=c("MET_848", "MET_100002717", "MET_100002719")
nicotine = fread("/home/baldanzi/Datasets/Metabolon/nicotine_metab.csv", header = T, 
                 na.strings = c("NA",""))
t = apply(nicotine[,nicmet,with=F], 2, function(x) {sum(is.na(x))})
t = t(as.data.frame(t))
rownames(t) = "Missing information"
knitr::kable(t, caption = "Nr participants with missing",table.attr = "style='width:80%;'", col.names = c("cotinine", "hydroxycotinine", "cotinine N-oxide")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```
   
   
**Box plots**  
  
  
```{r nicotione_metabolites_boxplots, echo=FALSE, fig.align='center', out.width="50%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/smokcotinine.png")
#knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/smokhydroxycotinine.png")
#knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/smokcotinineNoxide.png")
```
<br>   
**Histograms**   
   
      
```{r nicotine_cotinine_hist, echo=FALSE, fig.align='center', out.width="70%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/smokcotinine_hist.png")
```
    
Zooming at the plot origin     
    
    
```{r nicotine_cotinine_hist2, echo=FALSE, fig.align='center', out.width="70%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/smokcotinine_hist_zoomed.png")
```
   
<br>  
**Cross tabulations with smoking status**    
   
Cotinine cutoff = min value (0.0003)

```{r nicotine_cotinine_ct1,echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Cross tabulation Cotinine with min value 
nicotine[,cotinine_pa:=NULL]
nicotine[MET_848>0.0003,cotinine_pa:='present']
nicotine[MET_848<=0.0003,cotinine_pa:='absent']
t = nicotine %>% tabyl( cotinine_pa, smokestatus ) %>% 
  adorn_totals( where = c("row", "col") ) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns( position = "front" ) %>%
  adorn_title("combined")
knitr::kable(t, caption = "Cross tabulation- presence of cotinine vs smoking",table.attr = "style='width:100%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```
   
***      
      
**ROC for Cotinine and current smoker**   

```{r nicotine_cotinine_auc, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="50%", out.height="50%"}      
# ROC cotinine and current smoking 
nicotine[smokestatus=="current", current :=1]
nicotine[smokestatus!="current", current :=0]

my_roc <- roc(nicotine$current, nicotine$MET_848)
a = coords(my_roc, "best", best.method = "youden", 
           ret = c("threshold", "specificity", "sensitivity"), 
           transpose=TRUE)
a=t(as.data.frame(a))
rownames(a)=NULL
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/cotinineROC.png")
knitr::kable(a, table.attr = "style='width:80%;'") %>% 
  kable_styling()
```
    
**Cross tabulations with smoking status**      

Cotinine cutoff based on the ROC

```{r nicotine_cotinine_ct2,echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Cross tabulation Cotinine with ROC cutoff value 
nicotine[,cotinine_pa:=NULL]
nicotine[MET_848>a[1],cotinine_pa:='present']
nicotine[MET_848<=a[1],cotinine_pa:='absent']
t = nicotine %>% tabyl( cotinine_pa, smokestatus ) %>% 
  adorn_totals( where = c("row", "col") ) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns( position = "front" ) %>%
  adorn_title("combined")
knitr::kable(t, caption = "Cross tabulation- presence of cotinine vs smoking",table.attr = "style='width:100%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

<br>  

**Cotinine information in those missing information on smokestatus**     

```{r cotinine_smokingstatus_missing, echo=FALSE, message=FALSE, warning=FALSE}
n1 = sum(is.na(valid.ahi[,smokestatus]))
n2 = sum(valid.ahi[is.na(smokestatus),SCAPISid] %in% nicotine[!is.na(MET_848),SCAPISid])
n3 = sum(is.na(nicotine[SCAPISid %in% valid.ahi[is.na(smokestatus),SCAPISid], MET_848]))
```
Out of `r n1` individuals with missing smoking status information, `r n2` have information on cotinine and of `r n3` them are missing cotinine information 
   
   <br>  

***   
   <br>
   
**Cotinine and snus**   
   
```{r nicotine_cotinine_snus_box, echo=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/snuscotinine.png")
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/snuscotinine_neversmokers.png")
```   
   
   
#### Cross tabulation snus and smoking   
   
```{r smoking_snus_cross.tabulation, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
# Cross tabulation snus and smoking missingness 
load('/home/baldanzi/Sleep_apnea/Descriptive/snus_smoking')

# Cross tabulation snus and smoking 
t = compareGroups(smoke ~ snus, data = snus_smoking)
t1 = createTable(t, show.p.overall = F)
export2md(t1, which.table = "descr", 
          format = "html", strip = TRUE, caption = "Snus vs smoking")  %>%
  kable_styling()
```
   
```{r smoking_snus_cross.tabulation2, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
t = compareGroups(smoke_missing ~ snus_missing , data = snus_smoking)
t1 = createTable(t, show.p.overall=F)
export2md(t1, which.table = "descr",  
          format = "html", strip = TRUE, caption = "Snus vs smoking missing information")  %>%
  kable_styling()
```

<br>


***

<br>
   
### Alcohol use    
     
     
```{r plotsahiandalcohol, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI and alcohol 
palkohol = ggplot(data = valid.ahi, aes(x=Alkohol,y=ahi)) + geom_point()  +
  ggtitle("AHI and alcohol") +  xlab("Alcohol (g/?)") + ylab("AHI") +
      geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash",alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash",alpha=.3) +
  geom_smooth(method='lm', alpha=.8) +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))
print(palkohol)
```
<br>

***

### Place of birth    

  
```{r plotsahiandpob, echo =FALSE, message=FALSE, warning=FALSE,fig.align='center'}

# AHI and place of birth
a=table(valid.ahi$pob, useNA = "ifany")
ppob = ggplot(data = valid.ahi, aes(y=ahi)) + geom_boxplot(aes(x=pob, fill=pob))  +
  ggtitle("AHI and place of birth") +  xlab("Place of birth") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=12), 
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(a),"\n(n=",a,")"))
print(ppob)
```

<br>

***

 
#   Missing values    

```{r missing1, echo = FALSE, warning=FALSE, message=FALSE}
miss = data.frame(Missing = apply(dat1,2,function(x){sum(is.na(x))}))
a = apply(dat1,2,function(x){sum(is.na(x))/length(x)})
misstable = cbind(Variables = rownames(miss), miss, Percentage = paste0(round(a*100,0)," %"))
misstable = as.data.frame(misstable %>% arrange(-miss))
rownames(misstable) = NULL
#t = flextable(miss)
#t = align(t,j=names(miss), align = "center")
#t = set_caption(t, caption = "Number of missing values by variable")
knitr::kable(misstable, caption = "Number of missing values by variable", 
             align = rep('c',3), table.attr = "style='width:60%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
# Number of individuals having at least one missing value for the covariates
perrow = apply(dat1, 1, function(x) {any(is.na(x))})
a = sum(perrow) #278
```

Individuals having at least one missing value for the covariates.   

N = **`r a`**   

<br>

**Comparing participants with incomplete vs complete observation**    
   
Incomplete obs = NA in any of the following variables:   
* Education   
* PA   
* Smoking  
* Alcohol (based on the FFQ)   
* Hypertension or diabetes diagnosis    
* Place of birth   
   
   
```{r missing2, echo = FALSE, warning=FALSE, message=FALSE}   
 load('/home/baldanzi/Sleep_apnea/Descriptive/completVSincompletObs')
export2md(t1, which.table = "descr", header.labels = c(p.overall = "p-value"), 
          format = "html", strip = TRUE) %>% 
  kable_styling(fixed_thead = T) %>% 
scroll_box( height = "850px")

```

<br>

***
<br>

# Interval between measurements

```{r dates1, echo=FALSE, message=FALSE, warning=FALSE }
valid.ahi[,metabolon_collection_date:=as.Date(valid.ahi[,metabolon_collection_date], 
                                              format = "%d-%b-%y")]
# Number of participants for which metabolon_collection_date is missing 
n1 = nrow(valid.ahi[is.na(metabolon_collection_date),]) # 1246
# Number of participants for which metabolon_colletion and sleep apnea assessment date 
# are the same
n2 = nrow(valid.ahi[date==metabolon_collection_date,]) # 1511
diff=abs(as.Date(valid.ahi[,date])-valid.ahi[,metabolon_collection_date])
n4 = paste0(median(as.numeric(diff),na.rm=T),
            " [", IQR(as.numeric(diff),na.rm=T),"]")

n5 = nrow(valid.ahi[diff>30,a,with=F]) # 10 individuals have a difference greater than 
# 30 days between dates
# Sleep assessment dates and Antropometric Collection Date 
# Missing data in anthropometric collection 
n6 = sum(is.na(valid.ahi[,AnthropometryCollectionDate])) # ZERO
# difference between the two dates 
diff2=abs(as.Date(valid.ahi[,date])-as.Date(valid.ahi[,AnthropometryCollectionDate]))
n7 = paste0(median(as.numeric(diff),na.rm=T),
            " [", IQR(as.numeric(diff),na.rm=T),"]")
n8 = nrow(valid.ahi[diff2>30,a,with=F]) # 23 had a difference greater than 30 days
```

## Interval between sleep recording and metabolomics collection   
   
* Missing metabolomics collection date = `r n1`
* Sleep records and metabolomics collection in the same day = `r n2`
* Median [IQR] difference in days = `r n4`
* Individuals with an interval >30days = `r n5`

## Interval between sleep recording and anthropometric collection
   
* Missing anthropometric collection date = `r n6`
* Median [IQR] difference in days = `r n7`
* Individuals with an interval >30days = `r n8`

<br>

***
<br>

# Alpha diversity  

## Shannon index 

```{r plotsshannon,echo=FALSE, message=FALSE, warning=FALSE}
setwd("/home/baldanzi/Datasets/sleep_SCAPIS")
valid.ahi = fread("validsleep_MGS.shannon.BC_Upp.tsv", header = T)

# Hist shannon diversity 
phistshannon=ggplot(data=valid.ahi,aes(x=shannon))+
  geom_histogram()+
  ggtitle("Histogram - Shannon diversity")
print(phistshannon)
```
<br>
<br>
```{r plotsshannonandahi,echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot shannon and ahi 
a = cor(valid.ahi$ahi, valid.ahi$shannon, method = "spearman")

pshannonahi = ggplot(data=valid.ahi) + 
  geom_point(aes(x=ahi, y= shannon)) + 
  ggtitle(paste0("Shannon index and AHI \n Spear. cor.= ",round(a,3))) + 
  xlab("Apnea-hypopnea index") +
  ylab("Shannon index") +
  geom_vline(xintercept = 5, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 15, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 30, color = "red", linetype = "twodash") +
   theme(plot.title = element_text(hjust = 0.5, size = 14))
print(pshannonahi)
```
<br>
<br>
```{r corrshannon, echo=FALSE, message=FALSE, warning=FALSE}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread("cor.shannon.ahi.tsv", header=T)
temp = c(4,6)
shannoncor = shannoncor[,-temp, with=F]
shannoncor[,estimate:=round(estimate,3)]
shannoncor[,p.value:=formatC(p.value,digits = 2, format ="e")]
knitr::kable(shannoncor, caption = "Correlation between Shannon diversity and AHI", 
             align = c('l','c','c','c','c')) %>% 
  kable_styling()
```
1. Model 1 = sex, age, plate, received 
2. Model 2 = + alcohol, smoking, BMI
3. Model 3 = + PA, education, place birth, fiber intake
4. Model 4 = + diabetes, hypertension, dyslipidemia, self-reported medication 

<br>
<br>
```{r plotsshannonandOSAcat,echo=FALSE, message=FALSE, warning=FALSE}
# Compare the Shannon index across two groups using Kruskal-Wallis
res=with(valid.ahi, kruskal.test(shannon ~ OSAcat))

valid.ahi$OSAcat = factor(valid.ahi$OSAcat, levels = c("no OSA", "Mild", "Moderate", "Severe"))

p3=ggplot(valid.ahi, aes(x=OSAcat, y=shannon)) +
  geom_violin(trim=FALSE, fill="indianred3")+
  geom_boxplot(width=0.1)+
  ggtitle(paste0("Shannon index by OSA severity - Kruskal-Wallis: p.value=",formatC(res$p.value,format= "e", digits=2)))+
  scale_x_discrete(labels=paste(names(table(valid.ahi$OSAcat))," (n=",table(valid.ahi$OSAcat),")",sep=""))+
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.title = element_text(size = 13), 
        axis.text.x = element_text(size = 12))+
  xlab("OSA severity")+
  ylab("Shannon Diversity Index")
print(p3)
```

<br>

***

<br>

# Bray-curtis dissimilarity 
```{r BCOSA, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
   
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/BC.OSAcat.png")
```


```{r BC, echo=FALSE, fig.cap="BC by OSA categories", out.width = '100%'}

#paletteLength <- 500
#myColor <- colorRampPalette(c("white","indianred3"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
#myBreaks <- c(seq(0, 0.5, length.out=ceiling(paletteLength/2) + 1), 
#              seq(1/paletteLength, 1, length.out=floor(paletteLength/2)))

#annotation = data.frame(OSAcat = valid.ahi[,OSAcat])
#rownames(annotation) = valid.ahi$SCAPISid
# Heatmap
#p5=pheatmap(BC,main="Heatmap",
#            legend_labels = "Bray-Curtis Dissimilarity",
#            color = myColor,show_rownames = FALSE, show_colnames = FALSE,
            # breaks = myBreaks,
#            cutree_rows = 2,
 #           cutree_cols = 2,cluster_rows = F,cluster_cols = F, 
  #          annotation_row = annotation,
  #          annotation_col = annotation)
#print(p5)
```

<br>

## Heatmap Bray-curtis dissimilarity   
```{r heatmapbcpicture, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
   
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/BC.heatmap.png")
```

<br>
<br>

## Bray curtis dissimilarity and OSA categories 

```{r permanovaOSA, echo =FALSE, message=FALSE, warning=FALSE}
setwd("/home/baldanzi/Sleep_apnea/Results")
permaOSA = fread("permanovaOSAcat.tsv", header =T)
perma = fread("permanovaahi.tsv", header=T)

knitr::kable(permaOSA[model=="model1",], caption="OSA and BC - model 1") %>% kable_styling()
knitr::kable(permaOSA[model=="model2",], caption = "OSA and BC - model 2") %>% kable_styling() 
```
***

## Bray-curtis dissimilartiy and AHI 

```{r permanovaAHI, echo=FALSE, message=FALSE, warning=FALSE}
knitr::kable(perma[model=="model1",], caption = "AHI and BC - model 1") %>% kable_styling()
knitr::kable(perma[model=="model2",], caption = "AHI and BC - model 2") %>% kable_styling()
```
<br>

***

<br>

# MGS prevalence 
```{r MGSprevalence, echo=FALSE, fig.align='center', out.width="70%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/hist.MGS.prevalence.png")
```


<br>
<br>
<br> 
  
# Appendix: Summary of all covariates   

```{r summaryall, echo = FALSE,fig.align='center'}
# Summary of variables
summaryall = sapply(names(dat1), function(x) {summary(dat1[[x]])})
print(summaryall)
```

# Appendix: technical variables of gut microbiome analysis. 

```{r cm_variables, echo=FALSE, message=FALSE, warning=FALSE}
#Number of plates 
n1 = length(unique(valid.ahi$plate)) # 55 plates

# Number of occasions that the samples was received
n2 = length(unique(valid.ahi$received))

# Average read.pairs.per.sample + dna.yield
n3 = round(mean(valid.ahi[,read.pairs.per.sample], na.rm = T)/(10^6),1)
n4 = round(mean(valid.ahi[,dna.yield], na.rm = T),2)
``` 
   
* Number of plates = `r n1`
* Number of occasions that samples were received = `r n2`
* Mean read-pair depth = `r n3`M
* Mean DNA yield = `r n4`

```{r cm_variables2, echo=FALSE, message=FALSE, warning=FALSE}
valid.ahi$read.per.million = valid.ahi$read.pairs.per.sample/(10^6)
tcm = compareGroups(OSAcat~read.per.million + dna.yield, data= valid.ahi)
t1 = createTable(tcm, show.p.overall = F)
export2md(t1, which.table = "descr", 
          format = "html", strip = TRUE, caption = "Technical variables by OSA categories")  %>%
  kable_styling()
```

