---
title: "Sleep apnea and gut microbiota"
author: "Gabriel Baldanzi"
date: " `r Sys.time()` "
output: 
  html_document:
    fig_width: 6
    fig_height: 4
    number_sections: TRUE
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 4
    css: style.css
---
```{css, echo=FALSE}
    body .main-container {
      max-width: 1500px !important;
      width: 1500px !important;
    }
    body {
      max-width: 1500px !important;
    }
    code.r { /* Code block */
    font-size: 14pt;
    }
    pre {
  font-size: 12px
    }
    .tocify-header {
    text-indent: initial;
}
    .tocify-subheader > .tocify-item {
  text-indent: initial;
  padding-left: 2em;
}
    ```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, 
	fig.align = 'center'
)
options(width = 20)
library(grid)
library(chron)
library(rio)
library(Hmisc)
library(tidyverse)
library(sjmisc)
library(summarytools)
library(janitor)
library(data.table)
library(flextable)
library(kableExtra)
library(compareGroups)
library(RColorBrewer)
library(pROC)
library(DT)
```

# Sleep recording 
   
```{r apnealinkpicture, echo=FALSE, fig.align='left', out.width="30%", out.height="30%"}
knitr::include_graphics("apnealink.jpeg")
```
   
<br>

```{r chunk1, message=FALSE, warning=FALSE, include=FALSE}
rm(list=ls())
setwd("/home/baldanzi/Datasets/sleep_SCAPIS/sleep_recording")
sleep = fread("Data_Sleep_SCAPIS_Uppsala.csv", header=T, na.strings=c("", "NA"))

# Data summary 
attach(sleep)
nr.idnr = length(idnr) # total number individuals 
nr.idnr.valid = length(idnr[flutv4h==1 & o2utv4h==1]) # number of ind with at least 4h of flow and sat monitoring 
fl = summary(fldeutv_min) 
fl = substr(times((fl%/%60 +  fl%%60 /60)/24), 1, 5) # Mean and median duration of flow monitoring 

sat = summary(spo2utv_min)
sat = substr(times((sat%/%60 +  sat%%60 /60)/24), 1, 5) # Mean and median duration of flow monitoring
detach(sleep)
#subsetting the dataset to only those with valid flow and sat monitoring 
valid.ahi = sleep[flutv4h==1 & o2utv4h==1,]
#subsetting the dataset to only those with valid sat monitoring (enough for analysis with ODI or Sat90%)
valid.t90 = sleep[o2utv4h==1,]

correlation = round(with(valid.ahi[!is.na(sat90),], cor(ahi,sat90)),3)
```
    
Total number of individuals    
N =  **`r nr.idnr`**   
   
Individuals with valid T90 measurements (at least 4hrs of saturation monitoring)        
N = **`r sum(sleep$o2utv4h==1)`**   
   
Individuals with valid AHI measurements (at least 4hrs of saturation and flow monitoring)      
N  = **`r nr.idnr.valid`**    

<br>

Correlation between AHI and T90 in the study pop. = **`r correlation`**   
<br>

## Monitoring variables {.tabset}

### Oximetry monitoring {-}

   
```{r summaryoximetry, echo =FALSE, message=FALSE, warning=FALSE}
a = data.frame(Estimates=names(sat), "HH:MM"=sat)
rownames(a) =NULL
knitr::kable(a, caption = "Duration of oximetry monitoring", table.attr = "style='width:40%;'") %>% 
  kable_styling()
```    


&nbsp;


*** 

### Flow monitoring {-}

```{r summaryflow, echo =FALSE, message=FALSE, warning=FALSE}   
a = data.frame(Estimates=names(fl), "HH:MM"=fl)
rownames(a) =NULL
knitr::kable(a, caption = "Duration of flow monitoring", table.attr = "style='width:40%;'") %>% 
  kable_styling()
```


&nbsp;


***   
   
<br>  
   
   
# Gut microbiome data 

Uppsala participants with gut microbiome data = **4839**   
   
```{r chunk2, message=FALSE, warning=FALSE, include=FALSE}
# Import data
pheno <- readRDS("/home/baldanzi/Datasets/sleep_SCAPIS/pheno.MGS.Upp.rds")

valid.ahi <- pheno[valid.ahi=='yes',]
valid.odi <- pheno[valid.t90=='yes',]

# Correlation t90 and ahi
ncor = round(with(pheno, cor(t90,ahi, method='spearman', use = 'complete.obs')),3)
``` 


<br>   
  
***   
   
<br>   

# Study population 

The Study population is comprised of Uppsala participants with both **valid AHI** and **gut microbiota** data 
    
N = **`r nrow(valid.ahi)`**   
   
<br>  
   
Participants with both **valid T90%** and **gut microbiota** data   
    
N= **`r nrow(valid.odi)`**
   
<br>  

# Sleep apnea variables

<br>
Variables:   
    
1. **AHI** (Apnea-hypopnea index)   
- Main parameter for OSA diagnosis and severity stratification   

* AHI 5-15 = Mild   
* AHI 15-30 = Moderate   
* AHI ≥30 = Severe   

<br>
2. **ODI** (Oxygen desaturation index)  
- Alternative variable for OSA diagnosis  

<br>
3. **Percentage of time with saturation below 90%**  
- Used for phenotypic characterization of OSA  
- Correlation between AHI and T90: rho = `r ncor`

<br>   

***

## AHI 
 
```{r sleeprecordsplots, echo = FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Histogram AHI
p3 = ggplot(data = valid.ahi, aes(x=ahi)) + 
  geom_histogram(color="black", fill="lightskyblue2") +
  geom_density(alpha=.3, fill="#FF6666") +
  ggtitle("Hist Apnea-hypopnea index (AHI)") +  xlab("") + 
  geom_vline(xintercept = 5, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 15, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 30, color = "red", linetype = "twodash") +
  annotation_custom(textGrob("5", gp = gpar(col = "red")), 
                    xmin=6.2, xmax=6.2,ymin=1000, ymax=1000) + 
   annotation_custom(textGrob("15", gp = gpar(col = "red")), 
                    xmin=16.7, xmax=16.7,ymin=1000, ymax=1000) +
     annotation_custom(textGrob("30", gp = gpar(col = "red")), 
                    xmin=31.8, xmax=31.8,ymin=1000, ymax=1000) +
  theme_light()+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5))
g = ggplotGrob(p3)
  g$layout$clip[g$layout$name=="panel"] <- "off"
  grid.draw(g)
```
<br>
<br> 

***
    
## OSA categories 
_Sleep apnea severity categories_
    
    
```{r OSAfreqtable, echo = FALSE, warning = FALSE, message=FALSE}
#Frequency table by OSA cat 
a = round(as.data.frame(freq(valid.ahi$OSAcat)),1)
a = a[,c(1,4,3)]
knitr::kable(a, caption = "OSA severity categories", table.attr = "style='width:60%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

<br>
<br>
    
***    
   
## T90% 
_% of time with oxygen saturation ≤ 90%_     

```{r T90, echo=FALSE, fig.align='center', out.width="50%", out.height="70%"}
n1=nrow(valid.odi)
```
        
Participants with valid T90% 
N = **`r n1`** 
     
```{r T902, echo=FALSE, fig.align='center', out.width="50%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/hist.sat90.png")
```

<br>

***

 <br>  

# Population characteristics  
   
 <br>  

```{r table1but2,echo=FALSE, message=FALSE, warning=FALSE}
t1 <- readRDS('/home/baldanzi/Sleep_apnea/Descriptive/sleepapnea_table1.rds')

export2md(t1, which.table = "descr", header.labels = c(p.overall = "p-value"), 
          format = "html", strip = TRUE) %>% 
  kable_styling(fixed_thead = T) %>% 
scroll_box( height = "850px")
```
<br>
<br>
<br>

***

## BMI and AHI  {.tabset}

### Table {-}

```{r bmi, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
t = valid.ahi %>% group_by(BMIcat) %>% summarise(N=length(BMIcat), mean_ahi = round(mean(ahi),1), median_ahi = median(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI and BMI category",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```


<br>

***

### Box plot {-}

```{r bmiahiboxplot, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
p <- ggplot(valid.ahi, aes(x=BMIcat, y = ahi, fill=BMIcat)) + geom_boxplot() + ggtitle("AHI by BMI categories") +
  ylab("AHI") + xlab("BMI categories") +
   theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=13),
        legend.position = "none")


```


<br>

***

### Scatter plot {-}

```{r plotsahiandbmi, echo =FALSE, message=FALSE, warning=FALSE,fig.align='center'}
# AHI by BMI
a = cor(valid.ahi$BMI, valid.ahi$ahi, method = "spearman")
pbmi = ggplot(data = valid.ahi, aes(y=ahi, x=BMI)) + geom_point()  +
  ggtitle(paste0("AHI and BMI \n Spear. cor = ",round(a,2))) +  
  xlab("BMI (kg/m2)") + ylab("AHI")+
    geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash", alpha=.3) +
  geom_smooth(method = 'lm') +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))
print(pbmi)

```

<br>   

***

## BMI and OSA severity  
```{r bmicat, echo=FALSE, message=FALSE, warning=FALSE}
t = compareGroups(BMIcat ~ OSAcat, data = valid.ahi)
t1 = createTable(t, show.p.overall=F)
export2md(t1, which.table = "descr",  
          format = "html", strip = TRUE, caption = "BMI vs OSA severity")  %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

<br>

***

## Other covariates 

### Sex

```{r plotsahi, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI by sex 
means = round(with(valid.ahi, tapply(ahi, Sex, mean)),1)
psex = ggplot(data = valid.ahi, aes(y=ahi)) + geom_boxplot(aes(x=Sex, fill=Sex))  +
  ggtitle("AHI and sex ") +  xlab("sex") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=13),
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(means),"\n(mean AHI=",means,")"))
                          
print(psex)
```
<br>

***

### Age

```{r plotsahiandage, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI by age 
page = ggplot(data = valid.ahi, aes(x=age,y=ahi)) + geom_point()  +
  ggtitle("AHI and age ") +  xlab("Age (yrs)") + ylab("AHI")+
    geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash",alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash",alpha=.3) +
  geom_smooth(method='lm', alpha=.8) +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))  
  
print(page)
```
<br>
   
```{r crosstabahiandage, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
# Create variable of age categories
valid.ahi[age<55, agegroup:=1]
valid.ahi[age>=55 & age <60, agegroup:=2]
valid.ahi[age>=60, agegroup:=3]
valid.ahi[,agegroup:=factor(agegroup, levels=c(1,2,3), labels = c("Age<55", "Age 55-60", "Age>=60"))]

# Create box plot of ahi by age group
means = round(with(valid.ahi, tapply(ahi, agegroup, mean)),1)

ggplot(valid.ahi, aes(x=agegroup, y=ahi, fill = agegroup)) +
  geom_boxplot() +
  ggtitle("AHI by age group") +  xlab("Age groups") + ylab("AHI")+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=12),
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(means),"\n(mean AHI=",means,")"))

# Create table of ahi by age group
t = valid.ahi %>% group_by(agegroup) %>% summarise(N=length(ahi), median_ahi = round(median(ahi),1), mean_ahi = mean(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI by age group",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
``` 

***    

<br>

### Smoking    
         
**Smokestatus**:   
*Derived variable based on answers to cqto001 (lifestyle questionnaire
item) and SmokerLab (oral question on smoking status asked prior to
lab sampling). Cqto001 is the main source variable. Regular and
occasional smokers according to cqto001 are both classified as current
smokers. If answer to cqto001 is missing or "Not willing/able to
reply", and SmokerLab is yes, this information is used instead.*   
   
<br>

#### Relation w/ sleep apnea  {.tabset}
    
##### AHI {-}

```{r plotsahiandsmoking, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}

# AHI and smoking 
a=table(valid.ahi$smokestatus, useNA = "ifany")
psmoke = ggplot(data = valid.ahi, aes(y=ahi)) + 
  geom_boxplot(aes(x=smokestatus, fill=smokestatus))  +
  ggtitle("AHI and smoking") +  xlab("Smoking status") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"),
        axis.text.x = element_text(size=13),
        legend.position = "none")+
  scale_x_discrete(labels=paste0(names(a),"\n(n=",a,")"))
print(psmoke)

# Create table of ahi by smokestatus 
t = valid.ahi %>% group_by(smokestatus) %>% summarise(N=length(ahi), median_ahi = round(median(ahi),1), mean_ahi = mean(ahi), sd_ahi = round(sd(ahi),1))
knitr::kable(as.data.table(t), caption = "AHI by smoking status",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
``` 

<br>

***

##### T90% {-}

```{r plotsahiandsmoking2, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}

# T90 and smoking 
valid.odi$smokestatus = factor(valid.odi$smokestatus,levels = c("never","former","current"))
a=table(valid.odi$smokestatus, useNA = "ifany")
psmoke = ggplot(data = valid.odi, aes(y=sat90)) + 
  geom_boxplot(aes(x=smokestatus, fill=smokestatus))  +
  ggtitle("T90% and smoking") +  xlab("Smoking status") + ylab("T90%") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"),
        axis.text.x = element_text(size=13),
        legend.position = "none")+
  scale_x_discrete(labels=paste0(names(a),"\n(n=",a,")"))
print(psmoke)

# Create table of t90 by smokestatus 
t = valid.odi %>% group_by(smokestatus) %>% summarise(N=length(sat90), median_t90 = round(median(sat90),1), mean_t90 = mean(sat90), sd_t90 = round(sd(sat90),1))
knitr::kable(as.data.table(t), caption = "T90% by smoking status",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
``` 

<br>

***
#### Smoking based on metabolome 
 Click [here](#smokemetabolon)
 
&nbsp;

***
   
### Alcohol
     
     
```{r plotsahiandalcohol, echo =FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# AHI and alcohol 
palkohol = ggplot(data = valid.ahi, aes(x=Alkohol,y=ahi)) + geom_point()  +
  ggtitle("AHI and alcohol") +  xlab("Alcohol (g/month)") + ylab("AHI") +
      geom_hline(yintercept = 5, color = "red", linetype = "twodash", alpha=.3) + 
  geom_hline(yintercept = 15, color = "red", linetype = "twodash",alpha=.3) + 
  geom_hline(yintercept = 30, color = "red", linetype = "twodash",alpha=.3) +
  geom_smooth(method='lm', alpha=.8) +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"))
print(palkohol)
```
<br>

***

### Place of birth    

  
```{r plotsahiandpob, echo =FALSE, message=FALSE, warning=FALSE,fig.align='center'}

# AHI and place of birth
a=table(valid.ahi$placebirth, useNA = "ifany")
ppob = ggplot(data = valid.ahi, aes(y=ahi)) + geom_boxplot(aes(x=placebirth, fill=placebirth))  +
  ggtitle("AHI and place of birth") +  xlab("Place of birth") + ylab("AHI") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5), 
        axis.title = element_text(size = 13, face = "bold"), 
        axis.text.x = element_text(size=12), 
        legend.position = "none") +
  scale_x_discrete(labels=paste0(names(a),"\n(n=",a,")"))
print(ppob)
```

<br>

***
### Fiber {.tabset}

#### Histogram 1 {-}

_Fiber intake in g/day_
   
```{r, echo=FALSE, message=FALSE, warning=FALSE }
pfiber = ggplot(valid.ahi, aes(x=Fibrer))+
  geom_histogram(color="black", fill="lightskyblue2") +
  geom_density(alpha=.3, fill="#FF6666") +
  ggtitle("Histogram - Fiber intake") +
  xlab("Fiber intake (g/day)") +
  theme_light()+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5),
        axis.title.x = element_text(size=14))
print(pfiber)
```

&nbsp;

***

&nbsp;
     
#### Histogram 2 {-}

_Fiber intake by energy intake in kcal_
   
```{r, echo=FALSE, message=FALSE, warning=FALSE }
pfiber = ggplot(valid.ahi, aes(x=fiber.kcal))+
  geom_histogram(color="black", fill="lightskyblue2") +
  geom_density(alpha=.3, fill="#FF6666") +
  ggtitle("Histogram - Fiber intake/Energy intake") +
  xlab("Fiber intake (g/kcal)") +
  theme_light()+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5),
        axis.title.x = element_text(size=14))
print(pfiber)
```

&nbsp;

***

&nbsp;

#### By OSA {-}

_Fiber intake by energy intake in kcal_
    
```{r fiber2, echo=FALSE, message=FALSE, warning=FALSE }
t = valid.ahi %>% group_by(OSAcat) %>% summarise(N=length(OSAcat), mean_fiber = round(mean(fiber.kcal, na.rm=T),1), median_fiber = round(median(fiber.kcal, na.rm=T),1), sd_fiber = round(sd(fiber.kcal, na.rm=T),1))
knitr::kable(as.data.table(t), caption = "Fiber intake by OSA category",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

&nbsp;

***

&nbsp;

### Energy intake {.tabset}

#### Histogram {-}

&nbsp;

```{r, echo=FALSE, message=FALSE, warning=FALSE }
pfiber = ggplot(valid.ahi, aes(x=Energi_kcal))+
  geom_histogram(color="black", fill="lightskyblue2") +
  geom_density(alpha=.3, fill="#FF6666") +
  ggtitle("Histogram - Energy intake") +
  xlab("Energy intake (cal/day)") +
  theme_light()+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5),
        axis.title.x = element_text(size=14))
print(pfiber)
```

&nbsp;

***

#### Box by PAL {-}

_Boxplot by leisure physical activity level_

```{r, echo=FALSE, message=FALSE, warning=FALSE }
pfiber = ggplot(valid.ahi, aes(y=Energi_kcal, x=leisurePA))+
  geom_boxplot(color="black", fill="lightskyblue2") +
  ggtitle("Boxplot Energy intake by leisure physical activity") +
  ylab("Energy intake (cal/day)") +
  theme_light()+
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 13, angle = 45,hjust=1))
print(pfiber)
```

&nbsp;

***

&nbsp;

## Season

```{r, echo=FALSE, message=FALSE, warning=FALSE }
  plot.data = valid.ahi %>% group_by(visit.month) %>% 
  summarise(N=length(visit.month), median = median(ahi), q25 = quantile(ahi)[2], 
            q75 = quantile(ahi)[4])

  ggplot(plot.data, aes(x=visit.month, y=median,group=1)) + geom_errorbar(aes(ymin=q25, ymax=q75), width=.3, color="gray60") + geom_line() + geom_point(color="gray30")
```

&nbsp;

***

&nbsp;

## Lung disease {.tabset}
   
 COPD, chronic bronchitis, and emphysema 
     
```{r, echo=FALSE, message=FALSE, warning=FALSE}
valid.t90 <- readRDS("/home/baldanzi/Datasets/sleep_SCAPIS/valid.t90_MGS.shannon_Upp.rds")

valid.t90[,Lung_disease:=as.factor(cqhe043)]
valid.ahi[,Lung_disease:=as.factor(cqhe043)]
valid.t90[Lung_disease=="NO_ANSWER",Lung_disease:=NA]
valid.ahi[Lung_disease=="NO_ANSWER",Lung_disease:=NA]

t = valid.ahi %>% group_by(Lung_disease) %>% summarise(N=length(Lung_disease), mean_ahi = round(mean(ahi, na.rm=T),1), median_ahi = round(median(ahi, na.rm=T),1), sd_ahi = round(sd(ahi, na.rm=T),1))
knitr::kable(as.data.table(t), caption = "AHI by Lung_disease",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

t = valid.t90 %>% group_by(Lung_disease) %>% summarise(N=length(Lung_disease), mean_t90 = round(mean(t90, na.rm=T),1), median_t90 = round(median(t90, na.rm=T),1), sd_t90 = round(sd(t90, na.rm=T),1))
knitr::kable(as.data.table(t), caption = "T90% by Lung_disease",table.attr = "style='width:80%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

***

#   Missing values    

**Comparing participants with incomplete vs complete observation**    
   
Incomplete observations are missing information in at least one the following variables:

* Education
* PA
* Smoking  
* Alcohol (based on the FFQ)
* Hypertension diagnosis
* Diabetes diagnosis    
* Place of birth  
* Fiber intake
* Energy intake
   
   
```{r missing2, echo = FALSE, warning=FALSE, message=FALSE}   
 load('/home/baldanzi/Sleep_apnea/Descriptive/completVSincompletObs')
export2md(t1, which.table = "descr", header.labels = c(p.overall = "p-value"), 
          format = "html", strip = TRUE) %>% 
  kable_styling(fixed_thead = T) %>% 
scroll_box( height = "850px")

```

<br>

```{r missing1, echo = FALSE, warning=FALSE, message=FALSE}
dat2 <- valid.ahi %>% select(age, Sex, smokestatus, Alkohol, BMI, educat,
                    leisurePA, placebirth, diabd, hypertension, dyslipidemia,
                    diabmed, hypermed, dyslipmed,
                    ppi,Fibrer,Energi_kcal, visit.month)

miss = data.frame(Missing = apply(dat2,2,function(x){sum(is.na(x))}))
a = apply(dat2,2,function(x){sum(is.na(x))/length(x)})
var=c("Age", "Sex", "Smoking","Alcohol","BMI","Education","Physical activity",   "Place of birth", "Diabetes", "Hypertension", "Dyslipidemia",
  "Diabetes medication","Hypertension medication", "Dyslipidemia medication", 
  "PPI","Fiber","Energy intake", "Visit month")

misstable <- cbind(Variables = var, miss, Percentage = paste0(round(a*100,0)," %"))
misstable <- as.data.frame(misstable %>% arrange(Variables))

knitr::kable(misstable, caption = "Number of missing values by variable", 
             align = rep('c',3), table.attr = "style='width:60%;'") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

# Number of individuals having at least one missing value for the covariates
perrow = apply(dat2, 1, function(x) {any(is.na(x))})
a = sum(perrow) #278
```

Individuals having at least one missing value for the covariates above.   

N = **`r a`**   

<br>

***
<br>

# Interval between measurements

```{r dates1, echo=FALSE, message=FALSE, warning=FALSE }
valid.ahi[,metabolon_collection_date:=as.Date(metabolon_collection_date,
                                              format = "%d-%b-%y")]
# Number of participants for which metabolon_collection_date is missing 
n1 = nrow(valid.ahi[is.na(metabolon_collection_date),]) # 1246
# Number of participants for which metabolon_colletion and sleep apnea assessment date 
# are the same
n2 = nrow(valid.ahi[date==metabolon_collection_date,]) # 1511
diff=abs(as.Date(valid.ahi[,date])-valid.ahi[,metabolon_collection_date])
n4 = paste0(median(as.numeric(diff),na.rm=T),
            " [", IQR(as.numeric(diff),na.rm=T),"]")

n5 = nrow(valid.ahi[diff>30,a,with=F]) # 10 individuals have a difference greater than 
# 30 days between dates
# Sleep assessment dates and Antropometric Collection Date 
# Missing data in anthropometric collection 
n6 = sum(is.na(valid.ahi[,AnthropometryCollectionDate])) # ZERO
# difference between the two dates 
diff2=abs(as.Date(valid.ahi[,date])-as.Date(valid.ahi[,AnthropometryCollectionDate]))
n7 = paste0(median(as.numeric(diff),na.rm=T),
            " [", IQR(as.numeric(diff),na.rm=T),"]")
n8 = nrow(valid.ahi[diff2>30,a,with=F]) # 23 had a difference greater than 30 days
```

<br>

## Sleep recording and metabolomics 
    
Interval between sleep recording and metabolomics collection
     
* Missing metabolomics collection date = `r n1`
* Sleep records and metabolomics collection in the same day = `r n2`
* Median [IQR] difference in days = `r n4`
* Mean difference in days = `r mean(diff)`
* Individuals with an interval >30days = `r n5`

<br>

## Sleep recording and anthropometric collection
   
Interval between sleep recording and anthropometric collection
    
* Missing anthropometric collection date = `r n6`
* Median [IQR] difference in days = `r n7`
* Mean difference in days = `r mean(diff2)`
* Individuals with an interval >30days = `r n8`

<br>

***
<br>

# Gut microbiota composition 

<br>

## Taxa abundance by OSA severity {.tabset} 

<br>

### Phyla  {-}

```{r phylum, echo=FALSE, fig.align='center', out.width="70%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/phyla_abundance_OSAcat.png")
```

&nbsp;

***

<br>

### Family {-}

```{r family, echo=FALSE, fig.align='center', out.width="70%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/family_abundance_OSAcat.png")
```

&nbsp;

***

<br>

# Alpha diversity  

## Shannon index 

```{r plotsshannon,echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
# Hist shannon diversity 
phistshannon=ggplot(data=valid.ahi,aes(x=shannon))+
  geom_histogram(color="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") +
  ggtitle("Histogram - Shannon diversity") +
  theme(plot.title = element_text(size = 16, face = "bold", hjust=0.5))
print(phistshannon)
```
<br>
<br>

### Shannon and AHI 

```{r plotsshannonandahi,echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
# Scatter plot shannon and ahi 
a = cor(valid.ahi$ahi, valid.ahi$shannon, method = "spearman")

pshannonahi = ggplot(data=valid.ahi,aes(x=ahi, y= shannon)) + 
  geom_point() + 
  ggtitle(paste0("Shannon index and AHI \n Spearman cor.= ",round(a,3))) + 
  xlab("Apnea-hypopnea index") +
  ylab("Shannon index") +
  geom_smooth(method='lm', alpha=.8) +
  geom_vline(xintercept = 5, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 15, color = "red", linetype = "twodash") + 
  geom_vline(xintercept = 30, color = "red", linetype = "twodash") +
   theme(plot.title = element_text(hjust = 0.5, size = 14))
print(pshannonahi)
```
<br>
<br>

#### Spearman Correlation between AHI and Shannon {.tabset} 

##### All {-}
   
```{r corrshannonAHI, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
shannoncor = fread('/home/baldanzi/Sleep_apnea/Results/cor_ahi_alpha.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[2:nrow(shannoncor),p.val:=as.character(round(p.value,digits = 3))]
shannoncor[1,p.val:=formatC(p.value[1],digits = 2, format ="e")]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between AHI and Shannon diversity index", 
             align = c('l','c','c','c','c','c')) %>% 
  kable_styling()
```
     
     
##### BMI<25 {-}
   
```{r corrshannonAHI2, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_ahi_alpha_bmi<25.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[,p.val:=round(p.value,digits = 3)]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI<25",              align = c('l',rep('c',times=7))) %>% 
  kable_styling()
```     

##### BMI >=25 & <30 {-}

```{r corrshannonAHI3, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_ahi_alpha_bmi25-30.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[,p.val:=round(p.value,digits = 3)]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI:25-30",              align = c('l',rep('c',times=7))) %>% 
  kable_styling()
```    

##### BMI >=30 {-}

```{r corrshannonAHI4, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_ahi_alpha_bmi>=30.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[,p.val:=round(p.value,digits = 3)]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI>=30",              align = c('l',rep('c',times=7))) %>% 
  kable_styling()
```    

#### {.unlisted .unnumbered}
1. Model 1 = sex + age + smoking + alcohol + plate 
2. Model 2 = + BMI 
3. Model 3 = + PA + education + place birth + fiber intake + energy intake + visit month + medication

5. Sens. Analysis = Removed medication users   
(ppi, metformin, anti-hypertensive, cholesterol-lowering)

<br>
<br>

```{r plotsshannonandOSAcat,echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
# Compare the Shannon index across 4 groups using Kruskal-Wallis
res=with(valid.ahi, kruskal.test(shannon ~ OSAcat))

valid.ahi$OSAcat = factor(valid.ahi$OSAcat, levels = c("no OSA", "Mild", "Moderate", "Severe"))

p3=ggplot(valid.ahi, aes(x=OSAcat, y=shannon)) +
  geom_violin(trim=FALSE, fill="indianred3")+
  geom_boxplot(width=0.1)+
  ggtitle(paste0("Shannon index by OSA severity \n Kruskal-Wallis: p.value=",formatC(res$p.value,format= "e", digits=2)))+
  scale_x_discrete(labels=paste(names(table(valid.ahi$OSAcat))," (n=",table(valid.ahi$OSAcat),")",sep=""))+
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.title = element_text(size = 13), 
        axis.text.x = element_text(size = 12))+
  xlab("OSA severity")+
  ylab("Shannon Diversity Index")
print(p3)
```

<br>
   
### Shannon and T90% 

```{r T90shannon, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="50%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/scatter.shannon.T90.png")
```

<br>

#### Spearman Correlation between T90% and Shannon {.tabset}

##### All {-}
   
```{r corrshannonT90, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
shannoncor = fread("/home/baldanzi/Sleep_apnea/Results/cor_t90_alpha.tsv", header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[2:nrow(shannoncor),p.val:=as.character(round(p.value,digits = 3))]
shannoncor[1,p.val:=formatC(p.value[1],digits = 2, format ="e")]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index", 
             align = c('l','c','c','c','c','c')) %>% 
  kable_styling()
```
     
##### BMI<25 {-}
   
```{r corrshannonT90_2, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_t90_alpha_bmi<25.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[2:nrow(shannoncor),p.val:=as.character(round(p.value,digits = 3))]
shannoncor[1,p.val:=formatC(p.value[1],digits = 2, format ="e")]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI<25", 
             align = c('l','c','c','c','c','c','c')) %>% 
  kable_styling()
```     
     
##### BMI>=25 & <30 {-}
   
```{r corrshannonT90_3, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_t90_alpha_bmi25-30.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[2:nrow(shannoncor),p.val:=as.character(round(p.value,digits = 3))]
shannoncor[1,p.val:=formatC(p.value[1],digits = 2, format ="e")]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI:25-30",              align = c('l',rep('c',times=7))) %>% 
  kable_styling()
```          
     
##### BMI >=30 {-}

```{r corrshannonT90_4, echo=FALSE, message=FALSE, warning=FALSE,fig.align='center'}
setwd("/home/baldanzi/Sleep_apnea/Results")
shannoncor = fread('cor_t90_alpha_bmi>=30.tsv', header=T)
temp = c(6,7)
shannoncor = shannoncor[,-temp, with=F]
setnames(shannoncor, "MGS", "Var 1")
setnames(shannoncor, "exposure", "Var 2")
shannoncor[,cor.coefficient:=round(cor.coefficient,3)]
shannoncor[2:nrow(shannoncor),p.val:=as.character(round(p.value,digits = 3))]
shannoncor[1,p.val:=formatC(p.value[1],digits = 2, format ="e")]
shannoncor[,p.value:=NULL]
setcolorder(shannoncor,c("model"))
knitr::kable(shannoncor, caption = "Correlation between T90% and Shannon diversity index, BMI>=30",              align = c('l',rep('c',times=7))) %>% 
  kable_styling()
```  


#### {.unlisted .unnumbered}     
1. Model 1 = sex + age + smoking + alcohol + plate 
2. Model 2 = + BMI 
3. Model 3 = + PA + education + place birth + fiber intake + energy intake +  visit month + medication

4. Sens. Analysis = removed medication users 
(PPI,Metformin,antihypertensive and cholesterol-lowering) 

***

<br>

# Beta-diversity 

## PCoA biplot {.tabset}

### Bray-curtis dissimilarity - OSA groups {-}
   
```{r BCOSA, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/BC.OSAcat.png")

perma_OSA_BC1 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_osa_bc.tsv')
perma_OSA_BC2 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_osa_bc.tsv')
perma_OSA_BC3 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_osa_bc.tsv')

perma_OSA_BCsa = fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_osa_bc.tsv')

n1 = perma_OSA_BC1[variables =="OSAcat", 'Pr(>F)']
n2 = perma_OSA_BC2[variables =="OSAcat", 'Pr(>F)']
n3 = perma_OSA_BC3[variables =="OSAcat", 'Pr(>F)']

nsa = perma_OSA_BCsa[variables =="OSAcat", 'Pr(>F)']

perma_AHI_BC1= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_ahi_bc.tsv')
perma_AHI_BC2= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_ahi_bc.tsv')
perma_AHI_BC3= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_ahi_bc.tsv')

perma_AHI_BCsa= fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_ahi_bc.tsv')

x1 = perma_AHI_BC1[variables =="ahi", 'Pr(>F)']
x2 = perma_AHI_BC2[variables =="ahi", 'Pr(>F)']
x3 = perma_AHI_BC3[variables =="ahi", 'Pr(>F)']

xsa = perma_AHI_BCsa[variables =="ahi", 'Pr(>F)']
```

PERMANOVA for OSA groups     
 * model 1 - p-value = `r n1`   
 * model 2 - p-value = `r n2`   
 * model 3 - p-value = `r n3`    
 
 * sens analysis  - p-value = `r nsa`    
    
PERMANOVA for AHI     
 * model 1 - p-value = `r x1`        
 * model 2 - p-value = `r x2`    
 * model 3 - p-value = `r x3`   
 
 * sens analysis - p-value = `r xsa`      
    
&nbsp; 

***



### Bray-curtis dissimilarity - T90% {-}
   
```{r BCOSA3, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/BC.T90.png")

perma_t90_BC1= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_t90_bc.tsv')
perma_t90_BC2= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_t90_bc.tsv')
perma_t90_BC3= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_t90_bc.tsv')
perma_t90_BCsa= fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_t90_bc.tsv')

n1 = perma_t90_BC1[variables =="t90", 'Pr(>F)']
n2 = perma_t90_BC2[variables =="t90", 'Pr(>F)']
n3 = perma_t90_BC3[variables =="t90", 'Pr(>F)']
nsa = perma_t90_BCsa[variables =="t90", 'Pr(>F)']
```

PERMANOVA for T90%     
* model 1 - p-value = `r n1`    
* model 2 - p-value = `r n2`     
* model 3 - p-value = `r n3`     
* sens analysis  - p-value = `r nsa`     


&nbsp; 

***

<br>

## Heatmap {.tabset}

### Bray-curtis dissimilarity {-}
     
```{r heatmapbcpicture, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/BC.heatmap.png")
```

&nbsp; 

***

### Aitchison distance  {-}
   
```{r heatmapbcpicture2, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/AitDist.heatmap.png")
```   


## Box plots 

### BC {.tabset}

#### Reference: No OSA {-}
```{r variancebetadiversity, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/Boxplot_BC_noOSA.png")
```   

&nbsp; 

***

#### Reference: Severe {-}
```{r variancebetadiversity2, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="60%", out.height="60%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/Boxplot_BC_severe.png")
```   

&nbsp; 

***

## PERMANOVA BC   
    
### OSA severity {.tabset}

#### model 1 {-}
   
```{r permanovaOSA, }
perma_OSA_BC1 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_osa_bc.tsv')
perma_OSA_BC1 = apply(perma_OSA_BC1,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_OSA_BC1, caption = "OSA and BC - model 1") %>% kable_styling()
```

&nbsp;

***

#### model 2 {-}
   
```{r permanovaOSA2, }
perma_OSA_BC2 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_osa_bc.tsv')
perma_OSA_BC2 = apply(perma_OSA_BC2,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_OSA_BC2, caption = "OSA and BC - model 2") %>% kable_styling()
```

&nbsp;

***

#### model 3 {-}
   
```{r permanovaOSA3, }
perma_OSA_BC3= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_osa_bc.tsv')
perma_OSA_BC3 = apply(perma_OSA_BC3,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_OSA_BC3, caption = "OSA and BC - model 3") %>% kable_styling()
```

&nbsp;

***


#### Sens. analysis {-}
   
 Excluded individuals using PPI, metformin, anti-hypertensive, or cholesterol-lowering medication
   
```{r permanovaOSAsa, }
perma_OSA_BCsa= fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_osa_bc.tsv')
perma_OSA_BCsa = apply(perma_OSA_BCsa,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_OSA_BCsa, caption = "OSA and BC - Sens. analysis") %>% kable_styling()
```

&nbsp;

***

### AHI {.tabset}
   
#### model 1 {-}
   
```{r permanovaAHI1, }
perma_AHI_BC1= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_ahi_bc.tsv')
perma_AHI_BC1 = apply(perma_AHI_BC1,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_AHI_BC1, caption = "AHI and BC - model 1") %>% kable_styling()
```
<br>

***

#### model 2 {-}
```{r permanovaAHI2, }
perma_AHI_BC2 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_ahi_bc.tsv')
perma_AHI_BC2 = apply(perma_AHI_BC2,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_AHI_BC2, caption = "AHI and BC - model 2") %>% kable_styling()
```
<br>

***

#### model 3 {-}
```{r permanovaAHI3, }
perma_AHI_BC3 = fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_ahi_bc.tsv')
perma_AHI_BC3 = apply(perma_AHI_BC3,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_AHI_BC3, caption = "AHI and BC - model 3") %>% kable_styling()
```
<br>

***

#### Sens Analysis {-}
  
Excluded individuals using PPI, metformin, anti-hypertensive, or cholesterol-lowering medication
  
```{r permanovaAHI5, }
perma_AHI_BCsa = fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_ahi_bc.tsv')
perma_AHI_BCsa = apply(perma_AHI_BCsa,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_AHI_BCsa, caption = "AHI and BC - Sensitivity analysis") %>% kable_styling()
```
<br>

***

### T90% {.tabset}

#### model 1 {-}
   
```{r permanovat90, }
perma_t90_BC1= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model1_t90_bc.tsv')
perma_t90_BC1 = apply(perma_t90_BC1,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_t90_BC1, caption = "T90% and BC - model 1") %>% kable_styling()
```

&nbsp;

***

#### model 2 {-}
   
```{r permanovat902, }
perma_t90_BC2= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model2_t90_bc.tsv')
perma_t90_BC2 = apply(perma_t90_BC2,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_t90_BC2, caption = "T90% and BC - model 2") %>% kable_styling()
```

&nbsp;

***

#### model 3 {-}
   
```{r permanovat903, }
perma_t90_BC3= fread('/home/baldanzi/Sleep_apnea/Results/permanova_model3_t90_bc.tsv')
perma_t90_BC3 = apply(perma_t90_BC3,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_t90_BC3, caption = "T90% and BC - model 3") %>% kable_styling()
```

&nbsp;

***

#### Sens. Analysis  {-}
   
 Excluded individuals using PPI, metformin, anti-hypertensive, or cholesterol-lowering medication
   
```{r permanovat904, }
perma_t90_BCsa= fread('/home/baldanzi/Sleep_apnea/Results/permanova_SA_t90_bc.tsv')
perma_t90_BCsa = apply(perma_t90_BCsa,2,function(x){ifelse(!is.na(x),x,"")})
knitr::kable(perma_t90_BCsa, caption = "T90% and BC - model 3 no medication") %>% kable_styling()
```

&nbsp;

***

<br>



# Appendix

## MGS prevalence 
```{r MGSprevalence, echo=FALSE, fig.align='center', out.width="70%", out.height="70%"}
knitr::include_graphics("/home/baldanzi/Sleep_apnea/Descriptive/hist.MGS.prevalence.png")
```

&nbsp;

***

&nbsp;

## Plot - Blautia_obeum____HG3A.0001

```{r,}
ggplot(valid.t90, aes(x=t90,y=Blautia_obeum____HG3A.0001)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ggtitle("Blautia_obeum____HG3A.0001") +
  ylab("T90%") + xlab("Relative abundance") + 
  theme(plot.title = element_text(size = 14, face = 'bold', hjust=.5))

ggplot(valid.t90, aes(x=t90cat,y=Blautia_obeum____HG3A.0001)) +
  geom_boxplot() +
  geom_smooth(method = 'lm') +
  ggtitle("Blautia_obeum____HG3A.0001") +
  ylab("T90%") + xlab("Relative abundance") + 
  theme(plot.title = element_text(size = 14, face = 'bold', hjust=.5),
        axis.text.x = element_text(size=12))
```

&nbsp;

## Plot - Dorea_formicigenerans____HG3A.0006

```{r,}
ggplot(valid.t90, aes(x=t90,y=Dorea_formicigenerans____HG3A.0006)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  ggtitle("Dorea_formicigenerans____HG3A.0006") +
  ylab("T90%") + xlab("Relative abundance") + 
  theme(plot.title = element_text(size = 14, face = 'bold', hjust=.5))

ggplot(valid.t90, aes(x=t90cat,y=Dorea_formicigenerans____HG3A.0006)) +
  geom_boxplot() +
  geom_smooth(method = 'lm') +
  ggtitle("Dorea_formicigenerans____HG3A.0006") +
  ylab("T90%") + xlab("Relative abundance") + 
  theme(plot.title = element_text(size = 14, face = 'bold', hjust=.5),
        axis.text.x = element_text(size=12))
```


&nbsp;

***

&nbsp;
## CLR transformation 
    
    
Central log-ratio (CLR) transformation is one of the established methods to transform compositional data.   
It consists on (1) taking the ratio of count value to the geometric mean of all values for that sample, and then (2) taking the log of the ratios. 
    
Neverthess, there is high Spearman correlation between relative abundances and clr transformed data


```{r clr,}
#count.clr = fread("/home/baldanzi/Datasets/sleep_SCAPIS/validsleep.mgs_clr_count.tsv",sep='\t')
# Extracting mgs relative abundances 
#a = grep("___",names(valid.ahi),value=T)
#mgs.ra=as.matrix(valid.ahi[,a,with=F])
#rownames(mgs.ra) = valid.ahi[,SCAPISid]

# Extracting mgs clr 
#a = grep("HG3A",names(count.clr),value=T)
#mgs.clr = as.matrix(count.clr[,a,with=F])
#rownames(mgs.clr) = count.clr[,SCAPISid]

# Correlation between the two mgs transformation by individuals 
#cor.ind=sapply(1:nrow(mgs.clr), function(i){
#  cor(mgs.clr[i,],mgs.ra[i,], method = "spearman")})

#summary(cor.ind)
```

&nbsp;

***

&nbsp;
  
## Summary of all covariates 

```{r summaryall, }
# Summary of variables
model3 <- c("age", "Sex", "smokestatus", "Alkohol", "BMI", "educat",
            "leisurePA", "placebirth", "diabd", "hypertension",
            "dyslipidemia","diabmed", "hypermed", "dyslipmed",
            "ppi","Fibrer","Energi_kcal", "visit.month")

summaryall = sapply(model3, function(x) {summary(pheno[,x,with=F])})
print(summaryall)
```


***

&nbsp;

## Variables of technical variation 

```{r cm_variables, }
#Number of plates 
n1 = length(unique(valid.ahi$plate)) # 55 plates

# Number of occasions that the samples was received
n2 = length(unique(valid.ahi$received))

# Average read.pairs.per.sample + dna.yield
n3 = round(mean(valid.ahi[,read.pairs.per.sample], na.rm = T)/(10^6),1)
n4 = round(mean(valid.ahi[,dna.yield], na.rm = T),2)
``` 
   
* Number of plates = `r n1`
* Number of occasions that samples were received = `r n2`
* Mean read-pair depth = `r n3`M
* Mean DNA yield = `r n4`

```{r cm_variables2, }
valid.ahi$read.per.million = valid.ahi$read.pairs.per.sample/(10^6)
tcm = compareGroups(OSAcat~read.per.million + dna.yield, data= valid.ahi)
t1 = createTable(tcm, show.p.overall = F)
export2md(t1, which.table = "descr", 
          format = "html", strip = TRUE, caption = "Technical variables by OSA categories")  %>%
  kable_styling()
```


&nbsp; 

***